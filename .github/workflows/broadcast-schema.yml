name: Broadcast Schema to Spokes

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    name: Generate Types
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate TypeScript Types
        run: npx supabase gen types typescript --project-id ${{ secrets.SUPABASE_PROJECT_ID }} > types/database.types.ts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Format Types
        run: node scripts/format-types.js || echo "No format script found, skipping"
      
      - name: Commit to Hub
        run: |
          git config user.name "EryAI Schema Bot"
          git config user.email "bot@eryai.tech"
          git add types/
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update database types from supabase" && git push)
      
      - name: Get EryAI repos
        id: get-repos
        run: |
          REPOS='["eryai-dashboard","eryai-engine","eryai-monitoring","eryai-sales","eryai-tech","eryai-demos","ery-ai-demo-restaurang","mimre"]'
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: broadcast-files
          path: |
            types/
            templates/

  broadcast:
    name: Push to ${{ matrix.repo }}
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.generate.outputs.repos) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: broadcast-files
          path: artifacts/
      
      - name: Push to ${{ matrix.repo }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 1. Clear any global credentials
          git config --global --unset-all http.https://github.com/.extraheader || true
          
          # 2. Clone with clear auth structure
          git clone "https://x-access-token:${GH_TOKEN}@github.com/eryai-tech/${{ matrix.repo }}.git" spoke-repo
          cd spoke-repo
          
          # 3. Fix package.json (restore first if corrupt, then inject dependencies)
          if [ -f "package.json" ]; then
            if ! node -e "JSON.parse(require('fs').readFileSync('package.json'))" 2>/dev/null; then
              echo "Corrupted JSON detected, restoring..."
              git checkout HEAD -- package.json
            fi
            
            node -e "
              const fs = require('fs');
              const p = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              p.devDependencies = p.devDependencies || {};
              p.devDependencies.typescript = '^5.0.0';
              p.dependencies = p.dependencies || {};
              p.dependencies['next-swagger-doc'] = '^0.4.0';
              p.dependencies['wait-on'] = '^7.2.0';
              // Remove invalid npm packages (schemathesis is Python, not npm)
              delete p.dependencies['schemathesis'];
              delete p.devDependencies['schemathesis'];
              fs.writeFileSync('package.json', JSON.stringify(p, null, 2) + '\n');
            "
          fi

          # 4. Sync types
          mkdir -p types
          cp ../artifacts/types/database.types.ts types/database.types.ts
          
          # 5. Sync jsconfig if exists
          if [ -f "../artifacts/templates/jsconfig.json" ]; then
            cp ../artifacts/templates/jsconfig.json jsconfig.json
          fi
          
          # 6. Sync CI workflow (with fingerprint check)
          mkdir -p .github/workflows
          if [ -f ".github/workflows/ci.yml" ]; then
            if grep -q "ERYAI_AUTO_GENERATED" .github/workflows/ci.yml || grep -q "ERYAI_CUSTOM_IMPLEMENTATION" .github/workflows/ci.yml; then
              if grep -q "ERYAI_CUSTOM_IMPLEMENTATION" .github/workflows/ci.yml; then
                echo "Skipping ci.yml - custom implementation detected"
              else
                cp ../artifacts/templates/ci.yml .github/workflows/ci.yml
              fi
            else
              # No fingerprint found, add it
              cp ../artifacts/templates/ci.yml .github/workflows/ci.yml
            fi
          else
            cp ../artifacts/templates/ci.yml .github/workflows/ci.yml
          fi
          
          # 7. Sync API templates (with fingerprint check)
          mkdir -p pages/api
          
          # Health endpoint
          if [ -f "pages/api/health.js" ]; then
            if grep -q "ERYAI_CUSTOM_IMPLEMENTATION" pages/api/health.js; then
              echo "Skipping health.js - custom implementation detected"
            else
              cp ../artifacts/templates/pages/api/health.js pages/api/health.js
            fi
          else
            cp ../artifacts/templates/pages/api/health.js pages/api/health.js
          fi
          
          # OpenAPI endpoint
          if [ -f "pages/api/openapi.js" ]; then
            if grep -q "ERYAI_CUSTOM_IMPLEMENTATION" pages/api/openapi.js; then
              echo "Skipping openapi.js - custom implementation detected"
            else
              cp ../artifacts/templates/pages/api/openapi.js pages/api/openapi.js
            fi
          else
            cp ../artifacts/templates/pages/api/openapi.js pages/api/openapi.js
          fi
          
          # 8. Sync Promptfoo config (with fingerprint check)
          if [ -f "promptfooconfig.yaml" ]; then
            if grep -q "ERYAI_CUSTOM_IMPLEMENTATION" promptfooconfig.yaml; then
              echo "Skipping promptfooconfig.yaml - custom implementation detected"
            else
              cp ../artifacts/templates/promptfooconfig.yaml promptfooconfig.yaml
            fi
          else
            cp ../artifacts/templates/promptfooconfig.yaml promptfooconfig.yaml
          fi
          
          # 9. Generate package-lock.json if missing
          if [ -f "package.json" ] && [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only
          fi
          
          # 10. Git config & Push
          git config user.name "EryAI Schema Bot"
          git config user.email "bot@eryai.tech"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/eryai-tech/${{ matrix.repo }}.git"
          
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: sync from eryai-core-schema" && git push origin main)
