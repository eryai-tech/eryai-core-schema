name: Broadcast Schema to Spokes

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  generate:
    name: Generate Types
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate TypeScript Types
        run: npx supabase gen types typescript --project-id ${{ secrets.SUPABASE_PROJECT_ID }} > types/database.types.ts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Format Types
        run: node scripts/format-types.js
      
      - name: Commit to Hub
        run: |
          git config user.name "EryAI Schema Bot"
          git config user.email "bot@eryai.tech"
          git add types/
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update database types from supabase" && git push)
      
      - name: Get EryAI repos
        id: get-repos
        run: |
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/users/shabajeric91-sketch/repos?per_page=100" | \
            jq -r '[.[] | select(.name | test("^eryai|^ery-ai")) | select(.name != "eryai-core-schema") | .name] | @json')
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Found repos: $REPOS"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: broadcast-files
          path: |
            types/
            templates/

  broadcast:
    name: Push to ${{ matrix.repo }}
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.generate.outputs.repos) }}
      fail-fast: false
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: broadcast-files
          path: artifacts/
      
      - name: Push to ${{ matrix.repo }}
        run: |
          echo "ðŸš€ Pushing to ${{ matrix.repo }}..."
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/shabajeric91-sketch/${{ matrix.repo }}.git spoke-repo
          cd spoke-repo
          
          # 1. Synka types
          mkdir -p types
          cp ../artifacts/types/database.types.ts types/database.types.ts
          
          # 2. Synka jsconfig.json
          cp ../artifacts/templates/jsconfig.json jsconfig.json
          
          # 3. Fix package.json - detect duplicates and restore
          if [ -f "package.json" ]; then
            # Check if package.json has duplicate keys (corrupted)
            DUPLICATE_COUNT=$(grep -c '"devDependencies"' package.json || echo "0")
            
            if [ "$DUPLICATE_COUNT" -gt "1" ]; then
              echo "âš ï¸ package.json has duplicate devDependencies ($DUPLICATE_COUNT found), restoring..."
              FOUND_CLEAN="false"
              # Find first commit that doesn't have duplicates (search up to 50 commits)
              for commit in $(git log --oneline -50 --format="%H" -- package.json); do
                COMMIT_DUPES=$(git show "$commit:package.json" 2>/dev/null | grep -c '"devDependencies"' || echo "0")
                if [ "$COMMIT_DUPES" -eq "1" ]; then
                  echo "âœ… Found clean package.json at $commit"
                  git show "$commit:package.json" > package.json
                  FOUND_CLEAN="true"
                  break
                fi
              done
              
              # If no clean version found, create a minimal one
              if [ "$FOUND_CLEAN" = "false" ]; then
                echo "âš ï¸ No clean version found, creating minimal package.json..."
                echo '{
  "name": "${{ matrix.repo }}",
  "version": "1.0.0",
  "dependencies": {},
  "devDependencies": {}
}' > package.json
              fi
            fi
            
            # Now safely update package.json with Node.js
            node -e "
              const fs = require('fs');
              try {
                const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                pkg.devDependencies = pkg.devDependencies || {};
                pkg.devDependencies['typescript'] = '^5.0.0';
                fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('âœ… package.json updated successfully');
              } catch (e) {
                console.error('âŒ Failed to update package.json:', e.message);
              }
            "
          fi
          
          # 4. Skapa CI workflow
          mkdir -p .github/workflows
          cat > .github/workflows/ci.yml << 'EOF'
          name: CI Validation

          on:
            push:
              branches: [main]
            pull_request:
              branches: [main]

          jobs:
            validate:
              name: Type Check & Build
              runs-on: ubuntu-latest
              
              steps:
                - uses: actions/checkout@v4
                
                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: '20'
                
                - name: Install dependencies
                  run: npm install
                
                - name: Run Type Check
                  run: |
                    if [ -f "jsconfig.json" ]; then
                      echo "Running type check..."
                      npx tsc --project jsconfig.json --skipLibCheck 2>&1 | head -50 > type-errors.log
                      if [ -s type-errors.log ] && grep -q "error TS" type-errors.log; then
                        echo "### âŒ Type Check Failed" >> $GITHUB_STEP_SUMMARY
                        echo "" >> $GITHUB_STEP_SUMMARY
                        echo "Copy this error to Claude:" >> $GITHUB_STEP_SUMMARY
                        echo '```' >> $GITHUB_STEP_SUMMARY
                        cat type-errors.log >> $GITHUB_STEP_SUMMARY
                        echo '```' >> $GITHUB_STEP_SUMMARY
                        exit 1
                      fi
                      echo "### âœ… Type Check Passed" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "### â­ï¸ Type Check Skipped (no jsconfig.json)" >> $GITHUB_STEP_SUMMARY
                    fi
                
                - name: Build
                  run: |
                    if grep -q '"build"' package.json 2>/dev/null; then
                      npm run build
                    else
                      echo "No build script found, skipping..."
                    fi
          EOF
          
          # Commit & Push
          git config user.name "EryAI Schema Bot"
          git config user.email "bot@eryai.tech"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: sync schema, jsconfig and CI from eryai-core-schema" && git push)
          echo "âœ… Done with ${{ matrix.repo }}"
