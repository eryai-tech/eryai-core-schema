name: Validate All Repos

on:
  # Triggas av spoke-repos vid push
  repository_dispatch:
    types: [repo_push]
  
  # Nattlig kÃ¶rning
  schedule:
    - cron: '0 3 * * *'
  
  # Manuell trigger
  workflow_dispatch:

jobs:
  # Om triggered av repo_push, validera bara det repot
  validate-single:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Extract repo name
        id: repo
        run: |
          FULL_REPO="${{ github.event.client_payload.repo }}"
          REPO_NAME="${FULL_REPO#eryai-tech/}"
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Validating: $REPO_NAME (triggered by push)"

      - name: Checkout ${{ steps.repo.outputs.name }}
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repo }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true

      - name: TypeScript Check
        run: |
          if grep -q '"typecheck"' package.json 2>/dev/null; then
            npm run typecheck
          elif [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          elif [ -f "jsconfig.json" ]; then
            echo "JavaScript project with JSConfig"
          else
            echo "No TypeScript config found, skipping"
          fi

      - name: Build Check
        run: |
          if grep -q '"build"' package.json 2>/dev/null; then
            npm run build
          else
            echo "No build script found, skipping"
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Summary
        run: |
          echo "## âœ… Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Repo:** ${{ github.event.client_payload.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.client_payload.sha }}" >> $GITHUB_STEP_SUMMARY

  # FÃ¶r scheduled/manual - validera alla repos
  discover:
    if: github.event_name != 'repository_dispatch'
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.find-repos.outputs.repos }}
    steps:
      - name: Find all repos in org
        id: find-repos
        run: |
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/orgs/eryai-tech/repos?per_page=100" | \
            jq -c '[.[] | select(.name | test("^eryai-|^ery-ai-|^mimre$")) | select(.name != "eryai-core-schema") | .name]')
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "ðŸ” Found repos: $REPOS"

  validate-all:
    if: github.event_name != 'repository_dispatch'
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.discover.outputs.repos) }}
    
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: eryai-tech/${{ matrix.repo }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true

      - name: TypeScript Check
        run: |
          if grep -q '"typecheck"' package.json 2>/dev/null; then
            npm run typecheck
          elif [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          elif [ -f "jsconfig.json" ]; then
            echo "JavaScript project with JSConfig"
          else
            echo "No TypeScript config found, skipping"
          fi
        continue-on-error: true

      - name: Build Check
        run: |
          if grep -q '"build"' package.json 2>/dev/null; then
            npm run build
          else
            echo "No build script found, skipping"
          fi
        continue-on-error: true
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  summary:
    if: github.event_name != 'repository_dispatch'
    needs: [discover, validate-all]
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸ” Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Repos validated:** ${{ needs.discover.outputs.repos }}" >> $GITHUB_STEP_SUMMARY
