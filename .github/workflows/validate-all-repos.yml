name: Validate All Repos

on:
  # KÃ¶r varje natt efter schema broadcast
  schedule:
    - cron: '0 3 * * *'  # 03:00 UTC (efter broadcast kl 02:00)
  
  # Manuell trigger
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: 
          - eryai-engine
          - eryai-dashboard
          - eryai-demos
          - eryai-sales
          - eryai-monitoring
          - eryai-tech
          - mimre
    
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: eryai-tech/${{ matrix.repo }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: TypeScript Check
        run: |
          if grep -q '"typecheck"' package.json 2>/dev/null; then
            npm run typecheck
          elif [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          else
            echo "No TypeScript config found, skipping..."
          fi
        continue-on-error: true

      - name: ESLint Check
        run: |
          if grep -q '"lint"' package.json 2>/dev/null; then
            npm run lint || echo "Lint warnings found"
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true

      - name: Build Check
        run: |
          if grep -q '"build"' package.json 2>/dev/null; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi
        continue-on-error: true

      - name: Health Endpoint Check
        run: |
          if [ -f "pages/api/health.js" ] || [ -f "pages/api/health.ts" ] || [ -f "app/api/health/route.ts" ] || [ -f "app/api/health/route.js" ]; then
            echo "âœ… Health endpoint found"
          else
            echo "âš ï¸ WARNING: No /api/health endpoint found"
          fi

  summary:
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸ” Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results above for details." >> $GITHUB_STEP_SUMMARY
