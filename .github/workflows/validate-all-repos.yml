name: Validate All Repos

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.find-repos.outputs.repos }}
    steps:
      - name: Find all repos in org
        id: find-repos
        run: |
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/orgs/eryai-tech/repos?per_page=100" | \
            jq -c '[.[] | select(.name | test("^eryai-|^ery-ai-|^mimre$")) | select(.name != "eryai-core-schema") | .name]')
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "ðŸ” Found repos: $REPOS"

  validate:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.discover.outputs.repos) }}
    
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: eryai-tech/${{ matrix.repo }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: TypeScript Check
        run: |
          if grep -q '"typecheck"' package.json 2>/dev/null; then
            npm run typecheck
          elif [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          else
            echo "No TypeScript config found, skipping..."
          fi
        continue-on-error: true

      - name: ESLint Check
        run: |
          if grep -q '"lint"' package.json 2>/dev/null; then
            npm run lint || echo "Lint warnings found"
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true

      - name: Build Check
        run: |
          if grep -q '"build"' package.json 2>/dev/null; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi
        continue-on-error: true
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Health Endpoint Check
        run: |
          if [ -f "pages/api/health.js" ] || [ -f "pages/api/health.ts" ] || [ -f "app/api/health/route.ts" ] || [ -f "app/api/health/route.js" ]; then
            echo "âœ… Health endpoint found"
          else
            echo "âš ï¸ WARNING: No /api/health endpoint found"
          fi

  summary:
    needs: [discover, validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸ” Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Repos validated:** ${{ needs.discover.outputs.repos }}" >> $GITHUB_STEP_SUMMARY
